name: Stress Test Workflow

env:
  GPGPackageKey: ${{ secrets.GPGPACKAGEKEY }}
  GPGPackagePassphrase: ${{ secrets.GPGPACKAGEPASSPHRASE }}
  KEYNAME: ${{ secrets.KEYNAME }}

on:
  pull_request:
  workflow_dispatch:
    inputs:
      name:
        type: choice
        description:
        options:
        - stress-Test

jobs:
  build:
    runs-on: self-hosted
    if:  GitHub.event.inputs.name == 'stress-Test'
    container:
      image: thinkpranav/almalinux8-build-essential@sha256:0f575dcf9908b5d19395dc1d5dd2843f3e0ca75b693ebccfa7b3d0c3b1b04c28
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Building packages
        run: |
          export CONCURRENCY="$(nproc)"
          export MAKEFLAGS="-j $CONCURRENCY"
          export BEEGFS_VERSION="$(test -n "${CI_COMMIT_TAG}" && echo "${CI_COMMIT_TAG}" || git describe --tags --match '*.*' --abbrev=8)"
          export GPG_TTY=$(tty)
          echo "bash .ci/build/packages.sh rpm"
